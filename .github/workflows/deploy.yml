name: Deploy Frontend to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_PATH: ${{ secrets.EC2_PATH }}

      run: |
        echo "$EC2_KEY" > key.pem
        chmod 600 key.pem

        echo "ğŸ” Connecting to EC2..."
        ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST << 'EOF'
          set -e  # Exit on error
          
          # Set deployment path
          APP_PATH="${EC2_PATH:-/home/ubuntu/front/zda-store}"
          
          echo "ğŸ“‚ Navigating to: $APP_PATH"
          cd "$APP_PATH" || { echo "âŒ Directory not found: $APP_PATH"; exit 1; }
          
          echo "ğŸ”„ Pulling latest code from GitHub..."
          git fetch origin main
          git reset --hard origin/main
          git clean -fd  # Remove untracked files
          
          echo "ğŸ“¦ Current commit:"
          git log -1 --oneline
          
          echo "ğŸ—‘ï¸  Cleaning previous build..."
          rm -rf .next
          rm -rf node_modules/.cache
          
          echo "ğŸ“¥ Installing dependencies..."
          yarn install --frozen-lockfile --production=false
          
          echo "ğŸ—ï¸  Building application..."
          yarn build
          
          # Verify build succeeded
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "ğŸ”„ Restarting PM2 process..."
          # Stop and delete existing process
          pm2 delete FrontEnd 2>/dev/null || true
          
          # Start new process with correct settings
          pm2 start "yarn start" \
            --name FrontEnd \
            --cwd "$APP_PATH" \
            --interpreter bash \
            --max-memory-restart 500M
          
          pm2 save
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“Š PM2 Status:"
          pm2 list
        EOF
        
        # Clean up
        rm -f key.pem
