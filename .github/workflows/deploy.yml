name: Deploy Store to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      # --------------------
      # Yarn cache (Berry)
      # --------------------
      - name: Restore Yarn cache
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            .yarn/unplugged
            .yarn/install-state.gz
            .yarn/build-state.yml
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-

      # --------------------
      # Next.js build cache
      # --------------------
      - name: Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/package.json', '**/yarn.lock') }}
          restore-keys: |
            nextjs-${{ runner.os }}-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Next.js
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
        run: yarn build

      # --------------------
      # Deploy + Run on EC2
      # --------------------
      - name: Deploy & Restart via PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          command_timeout: 30m
          script: |
            set -e
            cd ${{ secrets.APP_PATH }}

            # Pull latest build artifacts
            git pull origin main

            # Ensure pm2 exists
            if ! command -v pm2 >/dev/null; then
              npm install -g pm2
            fi

            # Restart app safely
            pm2 delete store || true
            pm2 start "yarn start" --name store
            pm2 save

            echo "âœ… Store is live via PM2"
